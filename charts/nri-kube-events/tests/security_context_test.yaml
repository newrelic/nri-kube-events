suite: test deployment security context
templates:
  - templates/deployment.yaml
release:
  name: my-release
  namespace: my-namespace
tests:
  - it: pod securityContext set to defaults when no values provided
    set:
      cluster: my-cluster
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
  - it: pod securityContext set common-library values
    set:
      cluster: test-cluster
      podSecurityContext:
        foobar: true
    asserts:
      - equal:
          path: spec.template.spec.securityContext.foobar
          value: true
  - it: pod securityContext compatibility layer overrides values from common-library
    set:
      cluster: test-cluster
      runAsUser: 1001
      podSecurityContext:
        runAsUser: 1000
        runAsNonRoot: false
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1001
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: false
  - it: pod securityContext compatibility layer overrides defaults
    set:
      cluster: test-cluster
      runAsUser: 1001
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1001
  - it: set to defaults when no containerSecurityContext set
    set:
      cluster: my-cluster
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.privileged
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.containers[1].securityContext
          value:
            allowPrivilegeEscalation: false
            privileged: false
            readOnlyRootFilesystem: true
  - it: set containerSecurityContext custom values
    set:
      cluster: test-cluster
      containerSecurityContext:
        foobar: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.foobar
          value: true
      - equal:
          path: spec.template.spec.containers[1].securityContext.foobar
          value: true
